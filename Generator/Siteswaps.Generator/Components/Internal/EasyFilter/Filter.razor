@using System.Diagnostics.CodeAnalysis
@inherits FluxorComponent
@inject IState<SiteswapGeneratorState> State
@inject IDispatcher Dispatcher

<AddFilterComponent
    EditFilterFinished="x => AddFilter(x)"
    Filter="IsNewFilter?null : State.Value.State.Filter[FilterNumber.Value]"
    State="State.Value.State"
/>
@code {

    [Parameter]
    public int? FilterNumber { get; set; }

    [MemberNotNullWhen(false, nameof(FilterNumber))]
    private bool IsNewFilter => FilterNumber is null;
    
    private void AddFilter(IFilterInformation filterInformation)
    {
        if (IsNewFilter)
        {
            Dispatcher.Dispatch(new NewFilterCreatedAction(filterInformation));
            return;
        }
        Dispatcher.Dispatch(new ChangedFilterAction(filterInformation, FilterNumber.Value));
    }
    
    public record NewFilterCreatedAction(IFilterInformation Value);

    public record ChangedFilterAction(IFilterInformation NewPatternFilterInformation, int FilterNumber);
    
    [ReducerMethod]
    public static SiteswapGeneratorState ReduceNewFilterCreatedActionAction(
        SiteswapGeneratorState state,
        NewFilterCreatedAction action
    )
    {
        return state with
        {
            State = state.State with { Filter = state.State.Filter.Add(action.Value) },
        };
    }

    [ReducerMethod]
    public static SiteswapGeneratorState ReduceFilterChangedActionAction(
        SiteswapGeneratorState state,
        ChangedFilterAction action
    )
    {
        return state with
        {
            State = state.State with
            {
                Filter = state
                    .State.Filter.RemoveAt(action.FilterNumber)
                    .Insert(action.FilterNumber, action.NewPatternFilterInformation),
            },
        };
    }
}
